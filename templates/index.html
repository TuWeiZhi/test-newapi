<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewAPI Keeper Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        h1 { color: #4CAF50; font-size: 28px; }
        .status-bar { display: flex; gap: 20px; align-items: center; margin-top: 15px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-dot.running { background: #4CAF50; animation: pulse 2s infinite; }
        .status-dot.idle { background: #757575; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .controls { display: flex; gap: 10px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        button:hover { background: #45a049; }
        button:disabled { background: #555; cursor: not-allowed; }
        .logs-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .log-panel { background: #2d2d2d; border-radius: 8px; padding: 20px; }
        .log-panel h2 { color: #4CAF50; margin-bottom: 15px; font-size: 20px; }
        .log-content { background: #1a1a1a; border: 1px solid #444; border-radius: 5px; padding: 15px; height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; }
        .log-line { margin-bottom: 8px; word-wrap: break-word; }
        .log-line.info { color: #4CAF50; }
        .log-line.error { color: #f44336; }
        .log-line.warning { color: #ff9800; }
        .log-line.detail { color: #2196F3; }
        .log-content::-webkit-scrollbar { width: 8px; }
        .log-content::-webkit-scrollbar-track { background: #1a1a1a; }
        .log-content::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        .log-content::-webkit-scrollbar-thumb:hover { background: #777; }
        @media (max-width: 1024px) { .logs-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NewAPI Keeper Dashboard</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot idle" id="statusDot"></div>
                    <span id="statusText">Idle</span>
                </div>
                <div class="status-item">
                    <span>Next Run: <strong id="nextRun">Loading...</strong></span>
                </div>
                <div class="controls">
                    <button id="triggerBtn" onclick="triggerTask()">Run Now</button>
                </div>
            </div>
        </header>

        <div class="logs-container">
            <div class="log-panel">
                <h2>Main Logs</h2>
                <div class="log-content" id="mainLogs"></div>
            </div>
            <div class="log-panel">
                <h2>Request Details</h2>
                <div class="log-content" id="detailLogs"></div>
            </div>
        </div>
    </div>

    <script>
        const mainLogs = document.getElementById('mainLogs');
        const detailLogs = document.getElementById('detailLogs');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const nextRun = document.getElementById('nextRun');
        const triggerBtn = document.getElementById('triggerBtn');
        
        const MAX_LOG_LINES = 1000;

        function addLog(container, message, type) {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            container.appendChild(line);
            
            while (container.children.length > MAX_LOG_LINES) {
                container.removeChild(container.firstChild);
            }
            
            container.scrollTop = container.scrollHeight;
        }
        
        function loadHistoryLogs() {
            fetch('/api/logs/history')
                .then(r => r.json())
                .then(data => {
                    data.main.forEach(line => {
                        let type = 'info';
                        if (line.includes('ERROR')) type = 'error';
                        else if (line.includes('WARNING')) type = 'warning';
                        addLog(mainLogs, line, type);
                    });
                    
                    data.detail.forEach(line => {
                        addLog(detailLogs, line, 'detail');
                    });
                })
                .catch(err => {
                    console.error('Failed to load history:', err);
                    addLog(mainLogs, `加载历史日志失败: ${err.message || err}`, 'error');
                });
        }

        function updateStatus() {
            fetch('/api/status')
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.running) {
                        statusDot.className = 'status-dot running';
                        statusText.textContent = 'Running';
                        triggerBtn.disabled = true;
                    } else {
                        statusDot.className = 'status-dot idle';
                        statusText.textContent = 'Idle';
                        triggerBtn.disabled = false;
                    }
                    if (data.next_run) {
                        const date = new Date(data.next_run);
                        nextRun.textContent = date.toLocaleString();
                    }
                })
                .catch(err => {
                    console.error('Failed to get status:', err);
                    statusText.textContent = 'Error';
                    addLog(mainLogs, `获取状态失败: ${err.message || err}`, 'error');
                });
        }

        function triggerTask() {
            fetch('/api/trigger', { method: 'POST' })
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(data => {
                            throw new Error(data.message || `HTTP ${r.status}: ${r.statusText}`);
                        }).catch(() => {
                            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        addLog(mainLogs, 'Task triggered manually', 'info');
                        updateStatus();
                    } else {
                        addLog(mainLogs, '触发任务失败: ' + (data.message || '未知错误'), 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to trigger task:', err);
                    addLog(mainLogs, `触发任务失败: ${err.message || err}`, 'error');
                });
        }

        const eventSource = new EventSource('/api/logs/stream');
        eventSource.onmessage = function(event) {
            const [type, message] = event.data.split('|', 2);
            if (type === 'ping') return;
            
            if (type === 'detail') {
                addLog(detailLogs, message, 'detail');
            } else {
                addLog(mainLogs, message, type);
            }
        };
        eventSource.onerror = function(event) {
            console.error('EventSource connection error:', event);
            if (eventSource.readyState === EventSource.CLOSED) {
                addLog(mainLogs, '日志流连接已关闭，请刷新页面重新连接', 'error');
            } else if (eventSource.readyState === EventSource.CONNECTING) {
                addLog(mainLogs, '日志流连接中断，正在尝试重新连接...', 'warning');
            }
        };

        loadHistoryLogs();
        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>
